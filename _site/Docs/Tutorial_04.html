<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
    <title>ILGPU - A Modern GPU Compiler for .Net Programs</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
  
    <!-- Favicons -->
    <link href="../assets/img/favicon.png" rel="icon">
    <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Jost:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
    <!-- Vendor CSS Files -->
    <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="../assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
     
    <script src="https://unpkg.com/boxicons@latest/dist/boxicons.js"></script>
  
    <!-- Template Main CSS File -->
    <link href="../assets/css/style.css" rel="stylesheet">

  <!-- Custom Styles CSS File -->
  <link href="../assets/css/custom-styles.css" rel="stylesheet">
    
  </head>

  <body class="wiki">
    <!-- ======= Header ======= -->
<header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center">

      <a href="../index.html" class="logo me-auto"><img src="../assets/img/ilgpu-logo.svg" alt="" class="img-fluid"></a>

      <nav id="navbar" class="navbar">
        <ul>
          <li class="dropdown"><a>About</a>
          <ul>
            <li><a href="../index.html#learn-more" class="scrollto">Learn More</a></li>
            <li><a href="../index.html#highlights" class="scrollto">Highlights</a></li>
            <li><a href="../index.html#features">Features</a></li>
            <li><a href="../index.html#news" class="scrollto">News</a></li>
            <li><a href="../index.html#faq">FAQ</a></li>
          </ul>
          </li>
          <li class="dropdown"><a class="scrollto" href="../index.html#about">Project</a>
            <ul>
              <li><a href="https://github.com/m4rs-mt/ILGPU/" class="scrollto">Sourcecode</a></li>
              <li><a href="../index.html#features">Releases</a></li>
              <li><a href="../index.html#news" class="scrollto">Milestones</a></li>
            </ul>
            </li>
        <li><a href="/wiki/home">Documentation</a></li>
        <li><a href="https://discord.com/invite/X6RBCff" target="_blank">Discord</a></li>
        <li><a class="getstarted scrollto" href="../index.html#cta">Get Started</a></li>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->


    <section id="sidebar">
    <div id="sidebar-header">
        <h4>Documentation</h4>
        </div>
    <nav id="wiki-nav">
        <h5>Primers</h5>
        <ul>
            <li><a href="/docs/Readme.html">Home</a></li> 
            <li><a href="/docs/Primer_00.html">Setting Up ILGPU</a></li>
            <li><a href="/docs/Primer_01.html">A GPU Is Not A CPU</a></li>
            <li><a href="/docs/Primer_02.html">Memory & Bandwidth Threads</a></li>
        </ul>
        <h5>Beginner</h5>
        <ul>
            <li><a href="/docs/Tutorial_01.html">Context & Accelerators</a></li> 
            <li><a href="/docs/Tutorial_02.html">Setting Up ILGPU</a></li>
            <li><a href="/docs/Tutorial_03.html">A GPU Is Not A CPU</a></li>
            <li><a href="/docs/Tutorial_04.html">Memory & Bandwidth Threads</a></li>
        </ul>
        <h5>Advanced</h5>
        <ul>
            <li><a href="/docs/Accelerators-and-Streams.html">Accelerators & Streams</a></li> 
            <li><a href="/docs/Memory-Buffers-and-Views.html">Memory Buffers & Views</a></li> 
            <li><a href="/docs/Kernels.html">Kernels</a></li> 
            <li><a href="/docs/Shared-Memory.html">Shared Memory</a></li> 
            <li><a href="/docs/Math-Functions.html">Math Functions</a></li> 
            <li><a href="/docs/Dynamically-Specialized-Kernels.html">Dynamically Specialized Kernels</a></li> 
            <li><a href="/docs/Debugging-and-Profiling.html">Debugging & Profiling</a</li> 
            <li><a href="/docs/Inside-ILGPU.html">Inside ILGPU</a></li> 
        </ul>
        
        <h5>Upgrade Guides</h5>
        <ul>
            <li><a href="/docs/Upgrade-v0.8.X-to-v0.9.X.html">v0.8.X to v0.9.X</a></li> 
            <li><a href="/docs/Upgrade-v0.8.0-to-v0.8.1.html">v0.8.0 to v0.8.1</a></li> 
            <li><a href="/docs/Upgrade-v0.7.X-to-v0.8.X.html">v0.7.X to v0.8.X</a></li> 
            <li><a href="/docs/Upgrade-v0.6.X-to-v0.7.X.html">v0.6.X to v0.7.X</a></li> 
            <li><a href="/docs/Upgrade-v0.3.X-to-v0.5.X.html">v0.3.X to v0.5.X</a></li> 
            <li><a href="/docs/Upgrade-v0.1.X-to-v0.2.X.html">v0.1.X to v0.2.X</a></li> 
          </ul>
    </nav>

    <div class="box">
        <span dd-toggle="theme" class="df">
          <div id="toggle_theme" class="dd-theme__switcher">
            <span class="dd-theme__switcher-btn">
              <svg xmlns="http://www.w3.org/2000/svg" class="dd-icon icon-tabler icon-tabler-sun" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" />
                <circle cx="12" cy="12" r="4" />
                <path d="M3 12h1M12 3v1M20 12h1M12 20v1M5.6 5.6l.7 .7M18.4 5.6l-.7 .7M17.7 17.7l.7 .7M6.3 17.7l-.7 .7" />
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" class="dd-icon icon-tabler icon-tabler-moon" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" />
                <path d="M16.2 4a9.03 9.03 0 1 0 3.9 12a6.5 6.5 0 1 1 -3.9 -12" />
              </svg>
            </span>
          </div>
          &nbsp;<label class="box-lbl" for="toggle_theme"><strong>Toggle Light/Dark Theme</strong></label>
      </div>

</section>
    <section id="wiki-main">
      <h1 id="structs">Structs</h1>

<p>As we saw in the <a href="Tutorial_02.md">memory tutorial</a> programs need data.
However a problem arises when we use ILGPU because it restricts how you can store, move, allocate, and access data.
This is mostly due to the fact that ILGPU is turning C# code into lower level languages.</p>

<h2 id="how-do-we-deal-with-this">How do we deal with this?</h2>
<p><em>Data is data is data.</em></p>

<blockquote>
  <p>Note: this example is a console version of the N-body template of my ILGPUView project.
When this is more ready I will include a link, but ILGPUView will allow you to see the result in realtime.</p>
</blockquote>

<h3 id="n-body-example">N-Body Example</h3>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">ILGPU</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ILGPU.Algorithms</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ILGPU.Runtime</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Drawing.Imaging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Context</span> <span class="n">context</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Default</span><span class="p">().</span><span class="nf">EnableAlgorithms</span><span class="p">());</span>
        <span class="n">Accelerator</span> <span class="n">device</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">GetPreferredDevice</span><span class="p">(</span><span class="n">preferCPU</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nf">CreateAccelerator</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">width</span> <span class="p">=</span> <span class="m">500</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">height</span> <span class="p">=</span> <span class="m">500</span><span class="p">;</span>
        
        <span class="c1">// my GPU can handle around 10,000 when using the struct of arrays</span>
        <span class="kt">int</span> <span class="n">particleCount</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span> 

        <span class="kt">byte</span><span class="p">[]</span> <span class="n">h_bitmapData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">width</span> <span class="p">*</span> <span class="n">height</span> <span class="p">*</span> <span class="m">3</span><span class="p">];</span>

        <span class="k">using</span> <span class="nn">MemoryBuffer2D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride2D</span><span class="p">.</span><span class="n">DenseY</span><span class="p">&gt;</span> <span class="n">canvasData</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">Allocate2DDenseY</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">Index2D</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">));</span>
        <span class="k">using</span> <span class="nn">MemoryBuffer1D</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">d_bitmapData</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">Allocate1D</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;(</span><span class="n">width</span> <span class="p">*</span> <span class="n">height</span> <span class="p">*</span> <span class="m">3</span><span class="p">);</span>

        <span class="n">CanvasData</span> <span class="n">c</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CanvasData</span><span class="p">(</span><span class="n">canvasData</span><span class="p">,</span> <span class="n">d_bitmapData</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

        <span class="k">using</span> <span class="nn">HostParticleSystem</span> <span class="n">h_particleSystem</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HostParticleSystem</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">particleCount</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">frameBufferToBitmap</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">LoadAutoGroupedStreamKernel</span><span class="p">&lt;</span><span class="n">Index2D</span><span class="p">,</span> <span class="n">CanvasData</span><span class="p">&gt;(</span><span class="n">CanvasData</span><span class="p">.</span><span class="n">CanvasToBitmap</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">particleProcessingKernel</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">LoadAutoGroupedStreamKernel</span><span class="p">&lt;</span><span class="n">Index1D</span><span class="p">,</span> <span class="n">CanvasData</span><span class="p">,</span> <span class="n">ParticleSystem</span><span class="p">&gt;(</span><span class="n">ParticleSystem</span><span class="p">.</span><span class="n">particleKernel</span><span class="p">);</span>

        <span class="c1">//process 100 N-body ticks</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="nf">particleProcessingKernel</span><span class="p">(</span><span class="n">particleCount</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h_particleSystem</span><span class="p">.</span><span class="n">deviceParticleSystem</span><span class="p">);</span>
            <span class="n">device</span><span class="p">.</span><span class="nf">Synchronize</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nf">frameBufferToBitmap</span><span class="p">(</span><span class="n">canvasData</span><span class="p">.</span><span class="n">Extent</span><span class="p">.</span><span class="nf">ToIntIndex</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
        <span class="n">device</span><span class="p">.</span><span class="nf">Synchronize</span><span class="p">();</span>

        <span class="n">d_bitmapData</span><span class="p">.</span><span class="nf">CopyToCPU</span><span class="p">(</span><span class="n">h_bitmapData</span><span class="p">);</span>

        <span class="c1">//bitmap magic that ignores bitmap striding, be careful some sizes will mess up the striding</span>
        <span class="k">using</span> <span class="nn">Bitmap</span> <span class="n">b</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bitmap</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="p">*</span> <span class="m">3</span><span class="p">,</span> <span class="n">PixelFormat</span><span class="p">.</span><span class="n">Format24bppRgb</span><span class="p">,</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">UnsafeAddrOfPinnedArrayElement</span><span class="p">(</span><span class="n">h_bitmapData</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
        <span class="n">b</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="s">"out.bmp"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Wrote 100 iterations of N-body simulation to out.bmp"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">struct</span> <span class="nc">CanvasData</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">ArrayView2D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride2D</span><span class="p">.</span><span class="n">DenseY</span><span class="p">&gt;</span> <span class="n">canvas</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">bitmapData</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">height</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CanvasData</span><span class="p">(</span><span class="n">ArrayView2D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride2D</span><span class="p">.</span><span class="n">DenseY</span><span class="p">&gt;</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">bitmapData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">canvas</span> <span class="p">=</span> <span class="n">canvas</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">bitmapData</span> <span class="p">=</span> <span class="n">bitmapData</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="n">width</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="n">height</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">setColor</span><span class="p">(</span><span class="n">Index2D</span> <span class="n">index</span><span class="p">,</span> <span class="n">Vec3</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">index</span><span class="p">.</span><span class="n">X</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">X</span> <span class="p">&lt;</span> <span class="n">canvas</span><span class="p">.</span><span class="n">IntExtent</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">Y</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">Y</span> <span class="p">&lt;</span> <span class="n">canvas</span><span class="p">.</span><span class="n">IntExtent</span><span class="p">.</span><span class="n">Y</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">canvas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">c</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CanvasToBitmap</span><span class="p">(</span><span class="n">Index2D</span> <span class="n">index</span><span class="p">,</span> <span class="n">CanvasData</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Vec3</span> <span class="n">color</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">canvas</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

            <span class="kt">int</span> <span class="n">bitmapIndex</span> <span class="p">=</span> <span class="p">((</span><span class="n">index</span><span class="p">.</span><span class="n">Y</span> <span class="p">*</span> <span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="p">+</span> <span class="n">index</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">;</span>

            <span class="n">c</span><span class="p">.</span><span class="n">bitmapData</span><span class="p">[</span><span class="n">bitmapIndex</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="m">255.99f</span> <span class="p">*</span> <span class="n">color</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
            <span class="n">c</span><span class="p">.</span><span class="n">bitmapData</span><span class="p">[</span><span class="n">bitmapIndex</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="m">255.99f</span> <span class="p">*</span> <span class="n">color</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
            <span class="n">c</span><span class="p">.</span><span class="n">bitmapData</span><span class="p">[</span><span class="n">bitmapIndex</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="m">255.99f</span> <span class="p">*</span> <span class="n">color</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

            <span class="n">c</span><span class="p">.</span><span class="n">canvas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">HostParticleSystem</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="n">Particle</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">particleData</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">ParticleSystem</span> <span class="n">deviceParticleSystem</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">HostParticleSystem</span><span class="p">(</span><span class="n">Accelerator</span> <span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">particleCount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Particle</span><span class="p">[]</span> <span class="n">particles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Particle</span><span class="p">[</span><span class="n">particleCount</span><span class="p">];</span>
            <span class="n">Random</span> <span class="n">rng</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">particleCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">Vec3</span> <span class="n">pos</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">rng</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">rng</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="n">height</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Particle</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">particleData</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="nf">Allocate1D</span><span class="p">(</span><span class="n">particles</span><span class="p">);</span>
            <span class="n">deviceParticleSystem</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ParticleSystem</span><span class="p">(</span><span class="n">particleData</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">particleData</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">struct</span> <span class="nc">ParticleSystem</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Particle</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">particles</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">gc</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">Vec3</span> <span class="n">centerPos</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">centerMass</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ParticleSystem</span><span class="p">(</span><span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Particle</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">particles</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">particles</span> <span class="p">=</span> <span class="n">particles</span><span class="p">;</span>

            <span class="n">gc</span> <span class="p">=</span> <span class="m">0.001f</span><span class="p">;</span>

            <span class="n">centerPos</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">width</span><span class="p">,</span> <span class="m">0.5f</span> <span class="p">*</span> <span class="n">height</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">centerMass</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">particles</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Vec3</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">ID</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">ID</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">particles</span><span class="p">[</span><span class="n">ID</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">particleKernel</span><span class="p">(</span><span class="n">Index1D</span> <span class="n">index</span><span class="p">,</span> <span class="n">CanvasData</span> <span class="n">c</span><span class="p">,</span> <span class="n">ParticleSystem</span> <span class="n">p</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Vec3</span> <span class="n">pos</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
            <span class="n">Index2D</span> <span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Index2D</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
            <span class="n">c</span><span class="p">.</span><span class="nf">setColor</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">struct</span> <span class="nc">Particle</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Vec3</span> <span class="n">position</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">Vec3</span> <span class="n">velocity</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">Vec3</span> <span class="n">acceleration</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">Particle</span><span class="p">(</span><span class="n">Vec3</span> <span class="n">position</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
            <span class="n">velocity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">();</span>
            <span class="n">acceleration</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">updateAcceleration</span><span class="p">(</span><span class="n">ParticleSystem</span> <span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">acceleration</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">();</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">d</span><span class="p">.</span><span class="n">particles</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">Vec3</span> <span class="n">otherPos</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">mass</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="n">ID</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//creates a mass at the center of the screen</span>
                    <span class="n">otherPos</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">centerPos</span><span class="p">;</span>
                    <span class="n">mass</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">centerMass</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">otherPos</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
                    <span class="n">mass</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kt">float</span> <span class="n">deltaPosLength</span> <span class="p">=</span> <span class="p">(</span><span class="n">position</span> <span class="p">-</span> <span class="n">otherPos</span><span class="p">).</span><span class="nf">length</span><span class="p">();</span>
                <span class="kt">float</span> <span class="n">temp</span> <span class="p">=</span> <span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">gc</span> <span class="p">*</span> <span class="n">mass</span><span class="p">)</span> <span class="p">/</span> <span class="n">XMath</span><span class="p">.</span><span class="nf">Pow</span><span class="p">(</span><span class="n">deltaPosLength</span><span class="p">,</span> <span class="m">3f</span><span class="p">);</span>
                <span class="n">acceleration</span> <span class="p">+=</span> <span class="p">(</span><span class="n">otherPos</span> <span class="p">-</span> <span class="n">position</span><span class="p">)</span> <span class="p">*</span> <span class="n">temp</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">updatePosition</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">position</span> <span class="p">=</span> <span class="n">position</span> <span class="p">+</span> <span class="n">velocity</span> <span class="p">+</span> <span class="n">acceleration</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">updateVelocity</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">velocity</span> <span class="p">=</span> <span class="n">velocity</span> <span class="p">+</span> <span class="n">acceleration</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">ParticleSystem</span> <span class="n">particles</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">updateAcceleration</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">ID</span><span class="p">);</span>
            <span class="nf">updatePosition</span><span class="p">();</span>
            <span class="nf">updateVelocity</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">struct</span> <span class="nc">Vec3</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">x</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Vec3</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">,</span> <span class="kt">float</span> <span class="n">z</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">y</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">z</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Vec3</span> <span class="k">operator</span> <span class="p">+(</span><span class="n">Vec3</span> <span class="n">v1</span><span class="p">,</span> <span class="n">Vec3</span> <span class="n">v2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">v2</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">v2</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">z</span> <span class="p">+</span> <span class="n">v2</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Vec3</span> <span class="k">operator</span> <span class="p">-(</span><span class="n">Vec3</span> <span class="n">v1</span><span class="p">,</span> <span class="n">Vec3</span> <span class="n">v2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">v2</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">v2</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">z</span> <span class="p">-</span> <span class="n">v2</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Vec3</span> <span class="k">operator</span> <span class="p">*(</span><span class="n">Vec3</span> <span class="n">v1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">v</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">float</span> <span class="nf">length</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">XMath</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">x</span> <span class="p">*</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span> <span class="p">*</span> <span class="n">y</span> <span class="p">+</span> <span class="n">z</span> <span class="p">*</span> <span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ok-this-is-a-long-one">Ok, this is a long one.</h2>
<p>I am not going to explain every line like I did with the kernel example.</p>

<p>I will however explain each struct. Lets start with the easy ones.</p>

<h3 id="vec3--particle">Vec3 &amp;&amp; Particle</h3>

<p>These are just simple data structures. C# is super nice lets you create member functions and 
constructors for structs.</p>

<h3 id="canvasdata">CanvasData</h3>

<p>You can just create a struct that holds ArrayViews and pass them to kernels. The issue with this is it seperates the MemoryBuffer and ArrayView into two different places.
There is nothing wrong with this but I think it leads to messy code. My attempt to fix this is the pattern that HostParticleSystem uses.</p>

<h3 id="particlesystem--hostparticlesystem">ParticleSystem &amp;&amp; HostParticleSystem</h3>

<p>You need to manage both sides of memory, Host and Device. IDisposable allows you to use the super convient “using” patterns but requires a class.
The solution is simple, have a host side class that creates a device side struct.</p>

<h2 id="this-sample-code-works-but">This sample code works… BUT</h2>
<p>This code can be MUCH faster.</p>

<h1 id="array-of-structs-vs-struct-of-arrays">Array of Structs VS Struct of Arrays</h1>
<p>The ParticleSystem struct follows a pattern called an array of structs, because its data is stored in an array of structs.
In RAM the array of structs(Particles) looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p0:
    pos
    vel
    accel
p1:
    pos
    vel
    accel
</code></pre></div></div>

<p>Consider what happens when the GPU loads the pos value from memory. The GPU is loading multiple pieces of data at a time. 
If the loads are “coherent” or how I think of it “chunked together” they will be MUCH faster.</p>

<p>We can do this my simply having 3 arrays. This causes memory to look like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pos0
pos1

vel0
vel1

accel0
accel1

</code></pre></div></div>

<p>This pattern is called a struct of arrays.</p>

<p>As you can see from the example it is much more complex to deal with, but at a particle count of 50,000 it is 5 times faster.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HostParticleSystemStructOfArrays</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">particleCount</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">positions</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">velocities</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">MemoryBuffer1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">accelerations</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">ParticleSystemStructOfArrays</span> <span class="n">deviceParticleSystem</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">HostParticleSystemStructOfArrays</span><span class="p">(</span><span class="n">Accelerator</span> <span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">particleCount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">particleCount</span> <span class="p">=</span> <span class="n">particleCount</span><span class="p">;</span>
        <span class="n">Vec3</span><span class="p">[]</span> <span class="n">poses</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vec3</span><span class="p">[</span><span class="n">particleCount</span><span class="p">];</span>
        <span class="n">Random</span> <span class="n">rng</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">particleCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">poses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">rng</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">rng</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="n">height</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">positions</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="nf">Allocate1D</span><span class="p">(</span><span class="n">poses</span><span class="p">);</span>
        <span class="n">velocities</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">Allocate1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">&gt;(</span><span class="n">particleCount</span><span class="p">);</span>
        <span class="n">accelerations</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">Allocate1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">&gt;(</span><span class="n">particleCount</span><span class="p">);</span>

        <span class="n">velocities</span><span class="p">.</span><span class="nf">MemSetToZero</span><span class="p">();</span>
        <span class="n">accelerations</span><span class="p">.</span><span class="nf">MemSetToZero</span><span class="p">();</span>

        <span class="n">deviceParticleSystem</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ParticleSystemStructOfArrays</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">accelerations</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">positions</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">velocities</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">accelerations</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">struct</span> <span class="nc">ParticleSystemStructOfArrays</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">positions</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">velocities</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">accelerations</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">gc</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Vec3</span> <span class="n">centerPos</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">centerMass</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ParticleSystemStructOfArrays</span><span class="p">(</span><span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">positions</span><span class="p">,</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">ArrayView1D</span><span class="p">&lt;</span><span class="n">Vec3</span><span class="p">,</span> <span class="n">Stride1D</span><span class="p">.</span><span class="n">Dense</span><span class="p">&gt;</span> <span class="n">accelerations</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">positions</span> <span class="p">=</span> <span class="n">positions</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">velocities</span> <span class="p">=</span> <span class="n">velocities</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">accelerations</span> <span class="p">=</span> <span class="n">accelerations</span><span class="p">;</span>
        <span class="n">gc</span> <span class="p">=</span> <span class="m">0.001f</span><span class="p">;</span>
        <span class="n">centerPos</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">width</span><span class="p">,</span> <span class="m">0.5f</span> <span class="p">*</span> <span class="n">height</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">centerMass</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">positions</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">updateAcceleration</span><span class="p">(</span><span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">accelerations</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">positions</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">Vec3</span> <span class="n">otherPos</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">mass</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="n">ID</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//creates a mass at the center of the screen</span>
                <span class="n">otherPos</span> <span class="p">=</span> <span class="n">centerPos</span><span class="p">;</span>
                <span class="n">mass</span> <span class="p">=</span> <span class="n">centerMass</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">otherPos</span> <span class="p">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">mass</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">float</span> <span class="n">deltaPosLength</span> <span class="p">=</span> <span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">-</span> <span class="n">otherPos</span><span class="p">).</span><span class="nf">length</span><span class="p">();</span>
            <span class="kt">float</span> <span class="n">temp</span> <span class="p">=</span> <span class="p">(</span><span class="n">gc</span> <span class="p">*</span> <span class="n">mass</span><span class="p">)</span> <span class="p">/</span> <span class="n">XMath</span><span class="p">.</span><span class="nf">Pow</span><span class="p">(</span><span class="n">deltaPosLength</span><span class="p">,</span> <span class="m">3f</span><span class="p">);</span>
            <span class="n">accelerations</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">+=</span> <span class="p">(</span><span class="n">otherPos</span> <span class="p">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">ID</span><span class="p">])</span> <span class="p">*</span> <span class="n">temp</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">particleKernel</span><span class="p">(</span><span class="n">Index1D</span> <span class="n">index</span><span class="p">,</span> <span class="n">CanvasData</span> <span class="n">c</span><span class="p">,</span> <span class="n">ParticleSystemStructOfArrays</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vec3</span> <span class="n">pos</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
        <span class="n">Index2D</span> <span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Index2D</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">setColor</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vec3</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">updatePosition</span><span class="p">(</span><span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">positions</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">+</span> <span class="n">velocities</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">+</span> <span class="n">accelerations</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">updateVelocity</span><span class="p">(</span><span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">velocities</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">=</span> <span class="n">velocities</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span> <span class="p">+</span> <span class="n">accelerations</span><span class="p">[</span><span class="n">ID</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Vec3</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">ID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">updateAcceleration</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span>
        <span class="nf">updatePosition</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span>
        <span class="nf">updateVelocity</span><span class="p">(</span><span class="n">ID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">positions</span><span class="p">[</span><span class="n">ID</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

      <div class="f5 contribution">
    <h2>Help us make these docs great!</h2>
    <p>All ILGPU docs are open source. See something that's wrong or unclear? Submit a pull request.</p>
        <a class="btn" href="https://github.com/m4rs-mt/ILGPU/edit/master/Docs/Tutorial_04.md" target="_blank" rel="noopener"><svg aria-hidden="true" role="img" class="octicon mr-1" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible"><path fill-rule="evenodd" d="M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"></path></svg>Make a contribution</a>
        <p class="color-fg-muted f6 mt-2">Or,<!-- --> <a href="https://github.com/m4rs-mt/ILGPU#general-contribution-guidelines" target="_blank" rel="noopener">learn how to contribute.</a></p>
    </div>
    </section>
      <!-- ======= Footer ======= -->
  <footer id="footer">

  

    <div class="container footer-bottom clearfix text-center">
      <div class="">
        &copy; Copyright <script type="text/javascript">document.write(new Date().getFullYear());</script> <span>ILGPU</span>. All Rights Reserved.
      </div>
      <div class="credits">
      </div>
    </div>
  </footer><!-- End Footer -->

  <div id="preloader"></div>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/waypoints/noframework.waypoints.js"></script>

  <!-- Template Main JS File -->
  <script src="../assets/js/main.js"></script>

  <!-- Easter Egg JS -->
  <script type="text/javascript">
    function easteregg() {
    var span = document.getElementById('easter-egg');
      if (span.textContent == 'ö') {
        span.textContent = 'œ' ;
      }
      else if (span.textContent == 'œ') {
        span.textContent = 'ö' ;
      }
    }
    </script>
    <div>
      <script type="text/javascript">
        // Set the theme from localStorage(if exist) || or set default light
let theme = window.localStorage.getItem('theme') || 'light';
// Activate the current theme (using class)
body.classList = theme;
// Available Themes
let available_themes = document.querySelectorAll('[dd-theme]');

/** Light / Dark theme Toggle */
// Toggle Dark / Light theme
let _toggler = document.querySelector('[dd-toggle]');
_toggler.addEventListener('click', toggleTheme);
// Function: toggle theme(light & dark)
function toggleTheme() {
 // Toggle light / dark theme
 ( theme == 'light' ? theme = 'dark' : theme = 'light');
 // Apply class to body
 body.classList = theme;
 // Store theme var to localStorage
 window.localStorage.setItem('theme', theme );
}
      </script>
    </div>
  </body>
</html>